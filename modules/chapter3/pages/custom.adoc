= Create a Custom Notebook Image

Custom notebook images allow you to add specific packages and libraries for your projects. This level of customization provides you with a consistent development environment for your teams to work in and ensures that your projects are reproducible between team members. You may also want to create custom notebooks that are more secure than the default notebook image provided in RHODS.

== Image source and Pre-built images

The default RHODS notebook images can be found in the https://github.com/opendatahub-io-contrib/workbench-images[opendatahub-io-contrib/workbench-images] repository. This repository contains the source code, pre-built images, and examples to help you create your own image. Workbench and runtime images are available.

*Workbench Images* +
These images can be used directly in workbenches within RHODS after importing them through the RHODS dashboard.

* Jupyter Data Science
* VSCode Data Science
* RStudio
* Jupyter PyTorch
* VSCode PyTorch
* Jupyter Tensorflow
* Jupyter Langchain
* Langflow 

*Runtime Images* +
These images can be used in Data Science Pipelines. They contain the exact same set of libraries as the above workbench images, except the IDE part.

* Runtime Data Science	
* Runtime Data Science (CUDA)	
* Runtime PyTorch (CUDA)	
* Runtime Tensorflow (CUDA)	
* Runtime R	
* Runtime Spark

For more information on OS packages, bundles, and IDE versions checkout the https://github.com/opendatahub-io-contrib/workbench-images#detailed-images-content[Detailed Images Content] section.

== Building your own images
We will now build our own image from one of the workbench images listed above.


=== Rules
* On OpenShift, every containers in a standard namespace (unless you modify security) run with a user with a random user id (uid), and the group id (gid) 0. Therefore, all the folders that you want to write in, and all the files you want to modify (temporarily) in your image must be accessible by this user. The *best practice* is to set the *ownership at 1001:0* (user "default", group "0").
* If you don't want/can't do that, another solution is to set permissions properly for any user, like 775.
* When launching a notebook from Applications->Enabled, the "personal" volume of a user is mounted at /opt/app-root/src. This is not configurable, so make sure to build your images with this default location for the data that you want persisted.

=== Requirements
* Need podman
* Need an image registry

=== Containerfile Overview
Before you start to edit the Containerfile lets go over what this Containerfile is doing.

image::customContainerFile.png[Custom Containerfile]

1. The FROM command contains the base image that we'll be using to build our custom image from. This will already contain common python packages that Data Scientists use.

2. The COPY command copies a requirements.txt file with the extra package that we will need in our notebook. 

3. The next step is to install the packages and remove then requirements.txt file that we just copied in to clean up files. 

4. We're printing out where Java is installed. Since we haven't installed it yet and it's not part of our base image we should expect the output to be blank.

5. We're switching to the root user (User 0). We need to do this to have the appropriate permissions to install OpenJDK.

6. Now we'll install OpenJDK. Note that we are combining multiple commands together with && instead of having each one run seperately. This helps keep the image size smaller.

7. After the isntallation command is completed we switch back to User 1001 since the root user is not allowed to run containers in OpenShift.

8. Now we should be able to see where Java is installed.

9. We'll fix the permissons to support pip in OpenShift.

10. Set the work directory,

11. Add the entry point for the container.

=== Build Steps

1. Open the requirements.txt file under modules/chapter3/examples. +
The only package we're installing is seaborn. It's a Python data visualization library that we'll use in our notebook. 
+
image::seabornReq.png[]
+
Multiple packages can be installed with the requirements.txt file by adding them on the next line. For example, the below requirements.txt file would install seaborn and the trino packages.
+
image::seabornTrinoReq.png[]

2. Open the Containerfile under modules/chapter3/examples and add the 3 commands below to the appropriate sections in the Containerfile. Refer to the Containerfile Overview section above to verify the correct location. 
+
[source, dockerfile]
----
   RUN INSTALL_PKGS="java-11-openjdk java-11-openjdk-devel" && \
      yum install -y --setopt=tsflags=nodocs $INSTALL_PKGS && \
      yum -y clean all --enablerepo='*'
----
+
[source, dockerfile]
----
   FROM quay.io/opendatahub-contrib/workbench-images:jupyter-datascience-c9s-py311_2023c_latest
----
+
[source, dockerfile]
----
   COPY requirements.txt ./
----
+
3. We'll now build the image with podman. Open a terminal and go to modules/chapter3/examples. Run the below command. 
+
[source]
----
podman build -t rhods-custom-image .
----
+
You should see the following in the log:
+
* The seaborn package is installed successfully.
+
image::podmanSeabornInstalled.png[]
+
* The first whereis Java command is blank
+
image::podmanNoJavaPath.png[]
+
* The second whereis Java command should display the path if Java was successfully installed.
+
image::podmanJavaPathExists.png[]

4. Once the image is done building run:
+
[source]
----
podman images
----
+
image::podmanImages.png[]
5. Login to quay.io
+
[source]
----
podman login quay.io
----
6. Push the image to your quay repository.
+
[source]
----
podman push rhods-admin-custom-image:latest quay.io/<YOUR_USERNAME>/rhods-admin-custom-image
----

Now you're ready to import your image into RHODS! See the next section to learn how to import your custom image and test it out.


